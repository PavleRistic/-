//-lgdi32
#include<stdio.h>
#include<stdlib.h>
#include<stdbool.h>
#include<windows.h>
#include<stdint.h>
#include<conio.h>
#define TS(b,v)case v:{t[b].PR=dl!=t[b].DL;t[b].DL=dl;}break;
float av[1],ov[1],ax[1],aX[1],oX[1],R=0.01f,dt=0.016666f;int G,A=0,aT[1],oT[1],aL[1],oL[1],aN[200],aE[200],oN[200],oE[200],D,V,z=0;bool I=1;struct Rs{void* M;BITMAPINFO bM;};Rs ren;int GD(int l,int o,int r){if(o<l)return l;if(o>r)return r;return o;}struct Ts{bool DL;bool PR;};Ts t[30];void C(int x0,int y0,int x1,int y1,unsigned int c){x0=GD(0,x0,D);x1=GD(0,x1,D);y0=GD(0,y0,V);y1=GD(0,y1,V);for(int y=y0;y<y1;y++){unsigned int* r=(unsigned int*)ren.M+x0+y*D;for(int x=x0;x<x1;x++)*r++=c;}}void OB(float r,float o,float x,float y,int d,unsigned int c){C(r,o,r+d,y,c);C(r,o,x,o+d,c);C(x-d,o,x,y,c);C(r,y-d,x,y,c);}void J(float x,float y,float h,float H,unsigned int c){x*=V*R;y*=V*R;h*=V*R;H*=V*R;x+=D/2.f;y+=V/2.f;int x0=x-h,x1=x+h,y0=y-H,y1=y+H;C(x0,y0,x1,y1,c);}void JA(float x,float y,float h,float H,unsigned int c){x*=V*R;y*=V*R;h*=V*R;H*=V*R;x+=D/2.f;y+=V/2.f;C(x,y,x+h,y+H,c);}const char* SL[][7]={" 00","0  0","0  0","0000","0  0","0  0","0  0","0000","0","0","000","0  0","0  0","000","0  0","0  0","0  0"," 000","   0","   0","   0"," 000"," 0 0"," 0 0"," 0 0","00000","0   0","0   0","0000","0","0","000","0","0","0000","0000","0","0","000","0","0","0"," 000","0","0","0","0","0","0","0   0","0   0"," 0 0","  0"," 0 0","0   0","0   0","0  00","0  00","0 0 0","0 0 0","0 0 0","00  0","00  0"," 000","   0","   0","   0","0  0","0  0"," 000","0  0","0  0","0 0","00","0 0","0  0","0  0","0","0","0","0","0","0","0000","00 00","0 0 0","0 0 0","0   0","0   0","0   0","0   0","0  0","0  0","0  0","0000","0  0","0  0","0  0","0000","0  0","0  0","0  0","0  0","0  0","0000","00000","0   0","0   0","0   0","0   0","0   0","0   0"," 000 ","0   0","0   0","0   0","0 0 0","0  0 "," 00 0","000","0  0","0  0","000","0   ","0   ","0   "," 000","0","0","0","0","0"," 000 ","00000","  0","  0","  0","  0","  0","  0","0   0","0   0","0   0"," 0 0","  0"," 0","0","00","0 0","0 0","000","0  0","0  0","000","","","","","","","","","","","","","","","","","","","","","","000","   00","    0"," 0000","    0","   00","000",};void TE(const char *H,float x,float y,float S,int c){float h=S*.5f,pj=y;while(*H){if(*H!=32){const char** sL;sL=SL[*H-'A'];float oj=x;for(int i=0;i<7;i++){const char* rE=sL[i];while(*rE){if(*rE=='0')J(x,y,h,h,c);x+=S;rE++;}y-=S;x=oj;}}H++;x+=S*6.f;y=pj;}}void O(float x,float y,float S,int* N,int* E){int r=0;float h=S*.5f;unsigned int c;while(r<200){if(E[r]==1)c=0xffff00;if(E[r]==2)c=0x800080;if(E[r]==3)c=0xff0000;if(E[r]==4)c=0x0000ff;if(E[r]==5)c=0x00ff00;if(E[r]==6)c=0xff7f00;if(E[r]==7)c=0x00ffff;if(E[r]==8)c=0x000030;if(N[r]==0){J(x+r%10*3,y-r/10*3,h,h,0x7f7f7f);OB((x-h+r%10*3)*V*R+D/2,(y-r/10*3-h)*V*R+V/2,(x+h+r%10*3)*V*R+D/2,(y-r/10*3+h)*V*R+V/2,1,0x5f5f5f);}else if(N[r]==1){J(x+r%10*3,y-r/10*3,h,h,c+99);OB((x-h+r%10*3)*V*R+D/2,(y-r/10*3-h)*V*R+V/2,(x+h+r%10*3)*V*R+D/2,(y-r/10*3+h)*V*R+V/2,1,c+9);}else{J(x+r%10*3,y-r/10*3,h,h,c);OB((x-h+r%10*3)*V*R+D/2,(y-r/10*3-h)*V*R+V/2,(x+h+r%10*3)*V*R+D/2,(y-r/10*3+h)*V*R+V/2,1,c+19);}r++;}}void BR(int n,float x,float y,float S,unsigned int c){float h=S*.5f;do{int r=n%10;n=n/10;switch(r){case 0:{J(x-S,y,h,2.5f*S,c);J(x+S,y,h,2.5f*S,c);J(x,y+S*2.f,h,h,c);J(x,y-S*2.f,h,h,c);x-=S*4.f;}break;case 1:{J(x+S,y,h,2.5f*S,c);x-=S*2.f;}break;case 2:{J(x,y+S*2.f,1.5f*S,h,c);J(x,y,1.5f*S,h,c);J(x,y-S*2.f,1.5f*S,h,c);J(x+S,y+S,h,h,c);J(x-S,y-S,h,h,c);x-=S*4.f;} break;case 3:{J(x-h,y+S*2.f,S,h,c);J(x-h,y,S,h,c);J(x-h,y-S*2.f,S,h,c);J(x+S,y,h,2.5f*S,c);x-=S*4.f;}break;case 4:{J(x+S,y,h,2.5f*S,c);J(x-S,y+S,h,1.5f*S,c);J(x,y,h,h,c);x-=S*4.f;}break;case 5:{J(x,y+S*2.f,1.5f*S,h,c);J(x,y,1.5f*S,h,c);J(x,y-S*2.f,1.5f*S,h,c);J(x-S,y+S,h,h,c);J(x+S,y-S,h,h,c);x-=S*4.f;}break;case 6:{J(x+h,y+S*2.f,S,h,c);J(x+h,y,S,h,c);J(x+h,y-S*2.f,S,h,c);J(x-S,y,h,2.5f*S,c);J(x+S,y-S,h,h,c);x-=S*4.f;}break;case 7:{J(x+S,y,h,2.5f*S,c);J(x-h,y+S*2.f,S,h,c);x-=S*4.f;}break;case 8:{J(x-S,y,h,2.5f*S,c);J(x+S,y,h,2.5f*S,c);J(x,y+S*2.f,h,h,c);J(x,y-S*2.f,h,h,c);J(x,y,h,h,c);x-=S*4.f;}break;case 9:{J(x-h,y+S*2.f,S,h,c);J(x-h,y,S,h,c);J(x-h,y-S*2.f,S,h,c);J(x+S,y,h,2.5f*S,c);J(x-S,y+S,h,h,c);x-=S*4.f;}break;}}while(n);}bool PT(int b){return t[b].DL&&t[b].PR;}int Z(int g,int y,int* N){int o=0;while(o<200){if(N[o]==2&&(o%10==g||N[o+y]==1||o+y>199))return 0;o++;}return 1;}void La(int* N,int* E){int r=200;if(Z(99,10,N))while(r>=0){if(N[r]==2){N[r]=0;N[r+10]=2;E[r+10]=E[r];E[r]=0;}r--;}}void LE(int* N,int* E){int r=0;while(r<200){if(N[r]==2){N[r]=0;N[r-1]=2;E[r-1]=E[r];E[r]=0;}r++;}}void DE(int* N,int* E){int r=200;while(r>=0){if(N[r]==2){N[r]=0;N[r+1]=2;E[r+1]=E[r];E[r]=0;}r--;}}void GE(int* N,int* E){int r=0;while(r<200){if(N[r]==2){N[r]=0;N[r-10]=2;E[r-10]=E[r];E[r]=0;}r++;}}void Da(int r,int d,int o,int l,int h,int c,int v,int* N,int* E){while(r+o<0||r+d<0||r+l<0){La(N,E);r+=10;}while(r+o>200||r+d>200||r+l>200){GE(N,E);r-=10;}if(N[r+d]!=1&&N[r+o]!=1&&N[r+l]!=1){if((r+o)%100/10==(r/10*10+5+o)%100/10&&(r+d)%100/10==(r/10*10+5+d)%100/10&&(r+l)%100/10==(r/10*10+5+l)%100/10){N[r+d]=2;N[r+o]=2;N[r+l]=2;N[r+h]=0;N[r+c]=0;N[r+v]=0;E[r+d]=E[r];E[r+o]=E[r];E[r+l]=E[r];E[r+h]=0;E[r+c]=0;E[r+v]=0;}else if((r+o)%100/10>(r/10*10+5+o)%100/10||(r+d)%100/10>(r/10*10+5+d)%100/10||(r+l)%100/10>(r/10*10+5+l)%100/10){if((r+o-1)%100/10==(r/10*10+4+o)%100/10&&(r+d-1)%100/10==(r/10*10+4+d)%100/10&&(r+l-1)%100/10==(r/10*10+4+l)%100/10&&Z(0,-1,N)){LE(N,E);r-=1;N[r+d]=2;N[r+o]=2;N[r+l]=2;N[r+h]=0;N[r+c]=0;N[r+v]=0;E[r+d]=E[r];E[r+o]=E[r];E[r+l]=E[r];E[r+h]=0;E[r+c]=0;E[r+v]=0;}else if(Z(0,-1,N)&&Z(0,-2,N)&&(r+o-2)%100/10==(r/10*10+3+o)%100/10&&(r+d-2)%100/10==(r/10*10+3+d)%100/10&&(r+l-2)%100/10==(r/10*10+3+l)%100/10){LE(N,E);LE(N,E);r-=2;N[r+d]=2;N[r+o]=2;N[r+l]=2;N[r+h]=0;N[r+c]=0;N[r+v]=0;E[r+d]=E[r];E[r+o]=E[r];E[r+l]=E[r];E[r+h]=0;E[r+c]=0;E[r+v]=0;}}else{if((r+o+1)%100/10==(r/10*10+6+o)%100/10&&(r+d+1)%100/10==(r/10*10+6+d)%100/10&&(r+l+1)%100/10==(r/10*10+6+l)%100/10&&Z(9,1,N)){DE(N,E);r+=1;N[r+d]=2;N[r+o]=2;N[r+l]=2;N[r+h]=0;N[r+c]=0;N[r+v]=0;E[r+d]=E[r];E[r+o]=E[r];E[r+l]=E[r];E[r+h]=0;E[r+c]=0;E[r+v]=0;}else if(Z(9,1,N)&&Z(9,2,N)&&(r+o+2)%100/10==(r/10*10+7+o)%100/10&&(r+d+2)%100/10==(r/10*10+7+d)%100/10&&(r+l+2)%100/10==(r/10*10+7+l)%100/10){DE(N,E);DE(N,E);r+=2;N[r+d]=2;N[r+o]=2;N[r+l]=2;N[r+h]=0;N[r+c]=0;N[r+v]=0;E[r+d]=E[r];E[r+o]=E[r];E[r+l]=E[r];E[r+h]=0;E[r+c]=0;E[r+v]=0;}}}}void Gl(int r,int d,int o,int l,int v,int* N,int* E){if(N[r]==1||N[d]==1||N[o]==1||N[l]==1)if(G==1)G=2;else if(G==3)G=4;N[r]=2;N[d]=2;N[o]=2;N[l]=2;E[r]=v;E[d]=v;E[o]=v;E[l]=v;}void IG(int h,int c,int* N,int* E,int y,float* x,float* X,float* v,int* T,int* L){int r=0;if(PT(10))I=0;else if(G==1||G==3){*x+=dt/400;int zT=dt*100000;*v+=dt;if(*v+*x>1)*v=77;if(*v==77&&*L!=0)*L=0;if(PT(y))*T+=7;r=0;if(PT(y))if(*T%7==1)while(r<200){if(N[r]==2){if(N[r+10]!=2){Da(r,0,0,-9,2,999,999,N,E);break;}else{if(N[r+11]!=2){Da(r,0,0,11,20,999,999,N,E);break;}else if(N[r+20]!=2){Da(r,0,0,20,9,999,999,N,E);break;}else{Da(r,0,0,9,0,0,0,N,E);break;}}}r++;}else if(PT(y))if(*T%7==2)while(r<200){if(N[r]==2){if(N[r+1]==2){Da(r,0,2,21,1,0,999,N,E);break;}else{Da(r,8,0,20,0,10,999,N,E);break;}break;}r++;}else if(PT(y))if(*T%7==3)while(r<200){if(N[r]==2){if(N[r+1]==2){if(N[r+2]==2)Da(r,-9,10,11,0,2,12,N,E);else Da(r,21,9,11,0,1,20,N,E);break;}else{if(N[r+20]==2)Da(r,-1,9,11,0,20,19,N,E);else Da(r,1,2,21,0,10,12,N,E);break;}break;}r++;}else if(PT(y))if(*T%7==4)while(r<200){if(N[r]==2){if(N[r+1]==2){if(N[r+2]==2)Da(r,-9,-10,11,0,2,10,N,E);else Da(r,10,2,12,0,1,21,N,E);break;}else{if(N[r+9]==2)Da(r,-1,19,20,0,8,10,N,E);else Da(r,19,9,11,0,20,21,N,E);break;}break;}r++;}else if(PT(y))if(*T%7==5)while(r<200){if(N[r]==2){if(N[r+1]==2){Da(r,0,11,-10,9,10,999,N,E);break;}else{Da(r,0,19,20,21,0,999,N,E);break;}break;}r++;}else if(PT(y))if(*T%7==6)while(r<200){if(N[r]==2){if(N[r+1]==2){Da(r,-8,-18,12,0,1,3,N,E);break;}else{Da(r,21,18,19,0,10,30,N,E);break;}break;}r++;}r=200;if(*T>27)*T-=28;if(PT(y+1)){if(Z(10,10,N))A+=1;La(N,E);}else if(*v==77)La(N,E);if(*v==77)*v=0;if(PT(y+2))if(Z(0,-1,N))LE(N,E);if(PT(y+3))if(Z(9,1,N))DE(N,E);if((PT(4)&&h!=30)||(PT(9)&&h==30))while(r>=0){if(Z(10,10,N)){A+=2;La(N,E);}else break;r-=10;}r=200;while(r>=0){if(!Z(10,10,N))*X+=1;if((*X>9999-*x*15||(PT(4)&&h!=30)||(PT(9)&&h==30))&&!Z(10,10,N)){*X=0;int o=0;while(o<200){if(N[o]==2)N[o]=1;o++;}if(zT%10<1){*T=0;Gl(5,6,15,16,1,N,E);}else if(zT%10<3){*T=1;Gl(5,14,15,16,2,N,E);}else if(zT%10<5){*T=2;Gl(5,4,15,16,3,N,E);}else if(zT%10<7){*T=3;Gl(5,4,16,6,4,N,E);}else if(zT%10<8){*T=4;Gl(5,25,15,26,5,N,E);}else if(zT%10<9){*T=5;Gl(5,14,15,6,6,N,E);}else{*T=6;Gl(5,4,6,7,7,N,E);}}r--;}r=199;while(r>9){if(N[r]==1&&N[r-1]==1&&N[r-2]==1&&N[r-3]==1&&N[r-4]==1&&N[r-5]==1&&N[r-6]==1&&N[r-7]==1&&N[r-8]==1&&N[r-9]==1){if(h==-50&&E[r]!=8&&E[r-1]!=8){for(int o=0;o<200;o++){if(aN[o]==1){aN[o]=0;aN[o-10]=1;aE[o-10]=aE[o];aE[o]=0;}}for(int o=199;o>189;o--){aN[o]=1;aE[o]=8;}aN[zT%10+190]=0;}if(h==30&&E[r]!=8&&E[r-1]!=8){for(int o=0;o<200;o++){if(oN[o]==1){oN[o]=0;oN[o-10]=1;oE[o-10]=oE[o];oE[o]=0;}}for(int o=199;o>189;o--){oN[o]=1;oE[o]=8;}oN[zT%10+190]=0;}for(int o=0;o<10;o++){N[r-o]=0;E[r-o]=0;}if(*L==0)*L=r;else *L+=1000;*X=70*dt;A+=20*(*L/1000+1);for(int o=r-10;o>=0;o--){if(N[o]==1){N[o]=0;N[o+10]=1;E[o+10]=E[o];E[o]=0;}}}r-=10;}if(G!=3)BR(A,-30,-30,1.f,0xbbffbb+A/10);O(h,c,3,N,E);if(*L!=0)JA(-1.5+h,28.5-(*L%1000)/10*3,30,(*L/1000+1)*3,0x3377cc);}else if(G==0){A=0;*x=0;if(PT(11))G=3;if(PT(9))G=1;while(r<200){N[r]=0;E[r]=0;r++;}r=0;int zT=dt*100000;if(zT%10<1){*T=0;Gl(5,6,15,16,1,N,E);}else if(zT%10<3){*T=1;Gl(5,14,15,16,2,N,E);}else if(zT%10<5){*T=2;Gl(5,4,15,16,3,N,E);}else if(zT%10<7){*T=3;Gl(5,4,16,6,4,N,E);}else if(zT%10<8){*T=4;Gl(5,25,15,26,5,N,E);}else if(zT%10<9){*T=5;Gl(5,14,15,6,6,N,E);}else{*T=6;Gl(5,4,6,7,7,N,E);}TE("PRITISNI ENTER",-50,-10,1,0xff0000);TE("PRITISNI I ZA DVA IGRACA",-75,-25,1,0xff0000);TE("TETRIS",-75,40,4.5,0xffffff);}else if(G==2||G==4){if((PT(9)&&h==-10)||PT(12))G=0;O(h,c,3,N,E);if(h==-10){BR(A,10,-30,2.f,0xbbffbb+A/10);TE("IZGUBIO SI",-60,0,2,0xff0000);}else{TE("GOTOVO",-30,0,2,0xff0000);TE("PRITISNI O",-25,-25,1,0xff0000);}}}LRESULT CALLBACK wp(HWND hwnd,UINT uMsg,WPARAM wParam,LPARAM lParam){LRESULT result=0;switch(uMsg){case WM_CLOSE:I=0;case WM_DESTROY:I=0;break;case WM_SIZE:{RECT rect;GetClientRect(hwnd,&rect);D=rect.right-rect.left;V=rect.bottom-rect.top;int S=D*V*sizeof(unsigned int);if(ren.M)VirtualFree(ren.M,0,MEM_RELEASE);ren.M=VirtualAlloc(0,S,MEM_COMMIT|MEM_RESERVE,PAGE_READWRITE);ren.bM.bmiHeader.biSize=sizeof(ren.bM.bmiHeader);ren.bM.bmiHeader.biWidth=D;ren.bM.bmiHeader.biHeight=V;ren.bM.bmiHeader.biPlanes=1;ren.bM.bmiHeader.biBitCount=32;ren.bM.bmiHeader.biCompression=BI_RGB;}break;default:{result=DefWindowProc(hwnd,uMsg,wParam,lParam);}}return result;}int WinMain(HINSTANCE hInstance,HINSTANCE hPrevInstance,LPSTR lpCmdLine,int nShowCmd){ShowCursor(0);WNDCLASS window_class={};window_class.style=CS_HREDRAW|CS_VREDRAW;window_class.lpszClassName="A";window_class.lpfnWndProc=wp;RegisterClass(&window_class);HWND pZ=CreateWindow(window_class.lpszClassName,"TETRIS",WS_OVERLAPPEDWINDOW|WS_VISIBLE,CW_USEDEFAULT,CW_USEDEFAULT,1280,720,0,0,hInstance,0);{SetWindowLong(pZ,GWL_STYLE,GetWindowLong(pZ,GWL_STYLE) & ~WS_OVERLAPPEDWINDOW);MONITORINFO mi={sizeof(mi)};GetMonitorInfo(MonitorFromWindow(pZ,MONITOR_DEFAULTTOPRIMARY),&mi);SetWindowPos(pZ,HWND_TOP,mi.rcMonitor.left,mi.rcMonitor.top,mi.rcMonitor.right-mi.rcMonitor.left,mi.rcMonitor.bottom-mi.rcMonitor.top,SWP_NOOWNERZORDER|SWP_FRAMECHANGED);}HDC hdc=GetDC(pZ);LARGE_INTEGER pc;QueryPerformanceCounter(&pc);float performance_frequency;{LARGE_INTEGER perf;QueryPerformanceFrequency(&perf);performance_frequency=(float)perf.QuadPart;}while(I){MSG po;for(int i=0;i<30;i++)t[i].PR=0;while(PeekMessage(&po,pZ,0,0,PM_REMOVE)){switch(po.message){case WM_KEYUP:case WM_KEYDOWN:{unsigned int vt=(unsigned int)po.wParam;bool dl=((po.lParam&(1<<31))==0);switch(vt){TS(0,VK_UP);TS(1,VK_DOWN);TS(2,VK_LEFT);TS(3,VK_RIGHT);TS(4,VK_SPACE);TS(5,'W');TS(6,'S');TS(7,'A');TS(8,'D');TS(9,VK_RETURN);TS(11,'I');TS(10,VK_ESCAPE);TS(12,'O');}}break;default:{TranslateMessage(&po);DispatchMessage(&po);}}}J(0,0,85,45,0x000044);OB(0,0,D,V,55,0x1111ee);if(G==0){ax[0]=0;aX[0]=0;oX[0]=0;av[0]=0;ov[0]=0;aT[0]=0;oT[0]=0;aL[0]=0;oL[0]=0;IG(30,30,aN,aE,0,ax,aX,av,aT,aL);IG(30,30,oN,oE,6,ax,oX,ov,oT,aL);}else if(G==1||G==2)IG(-10,30,aN,aE,0,ax,aX,av,aT,aL);else{IG(-50,30,oN,oE,5,ax,oX,ov,oT,oL);IG(30,30,aN,aE,0,ax,aX,av,aT,aL);}StretchDIBits(hdc,0,0,D,V,0,0,D,V,ren.M,&ren.bM,DIB_RGB_COLORS,SRCCOPY);LARGE_INTEGER en;QueryPerformanceCounter(&en);dt=(float)(en.QuadPart-pc.QuadPart)/performance_frequency;pc=en;}}
